<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Flip</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="global.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            z-index: 100;
        }

        .coin-container {
            margin-top: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .coin {
            width: 200px;
            height: 200px;
            perspective: 1000px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            border-radius: 50%;
            transform: rotateY(180deg);
        }

        .front,
        .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            object-fit: contain;
            border-radius: 50%;
        }

        .front {
            transform: rotateY(0deg);
        }

        .back {
            transform: rotateY(180deg);
        }

        .bet-container {
            display: flex;
            gap: 20px;
            margin: 20px;
        }

        .bet-box {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .bet-info {
            margin: 10px 0;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        input {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 150px;
        }

        #betStatusDisplay {
            position: fixed;
            top: 60px;
            right: 20px;
            font-size: 18px;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        @keyframes flipHeads {
            0% {
                transform: rotateY(180deg);
            }

            100% {
                transform: rotateY(1980deg);
            }
        }

        @keyframes flipTails {
            0% {
                transform: rotateY(180deg);
            }

            100% {
                transform: rotateY(2160deg);
            }
        }

        .coin.flip-heads .inner {
            animation: flipHeads 3s forwards;
        }

        .coin.flip-tails .inner {
            animation: flipTails 3s forwards;
        }

        #resultDisplay {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body>
    <div id="totalBetsHeader" class="header">
        TOPLAM BAHİS: 0 TOKEN
    </div>

    <div id="betStatusDisplay">
        Bahis Durumu Kontrol Ediliyor...
    </div>

    <div class="coin-container">
        <div id="coin" class="coin">
            <div class="inner">
                <img src="images/yazı.png" alt="Yazı" class="back">
                <img src="images/tura.png" alt="Tura" class="front">
            </div>
        </div>
        <div id="resultDisplay"></div>
        <div class="bet-container">
            <div class="bet-box">
                <h3>YAZI</h3>
                <div class="bet-info" id="headsInfo">Toplam Bahis: 0 TOKEN</div>
                <input type="number" id="headsAmount" placeholder="Bahis miktarı">
                <button onclick="betHeads()">YAZIYA BAHİS YAP</button>
            </div>

            <div class="bet-box">
                <h3>TURA</h3>
                <div class="bet-info" id="tailsInfo">Toplam Bahis: 0 TOKEN</div>
                <input type="number" id="tailsAmount" placeholder="Bahis miktarı">
                <button onclick="betTails()">TURAYA BAHİS YAP</button>
            </div>
        </div>
        <div id="myBetsDisplay"
            style="position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h4 style="margin: 0 0 10px 0;">Bahislerim</h4>
            <div>Yazı: <span id="myHeadsBets">0 TOKEN</span></div>
            <div>Tura: <span id="myTailsBets">0 TOKEN</span></div>
        </div>
    </div>

    <script>
        const COINFLIP_ADDRESS = '0x863d3B85EC42C0FaA5f910F85Fb8ff7096B4FA06';
        const TOKEN_ADDRESS = '0x84C96D49efd12BD71789576ffcF5aA8A72B8A7eb';

        const coinflipABI = [
            "function betHeads(uint256 amount, uint256 deadline, uint8 v, bytes32 r, bytes32 s)",
            "function betTails(uint256 amount, uint256 deadline, uint8 v, bytes32 r, bytes32 s)",
            "function isSelectingWinner() view returns (bool)",
            "function getHeadsLength() view returns (uint256)",
            "function getTailsLength() view returns (uint256)",
            "function headsAmount(uint256) view returns (uint256)",
            "function tailsAmount(uint256) view returns (uint256)",
            "function nthGame() view returns (uint256)",
            "function randoms(uint256) view returns (uint256[])",
            "function lastRequestId() view returns (uint256)",
            "function isWonTails() view returns (bool)",
            "function heads(uint256) view returns (address)",
            "function tails(uint256) view returns (address)"
        ];

        const tokenABI = [
            "function permit(address owner, address spender, uint256 value, uint256 deadline, uint8 v, bytes32 r, bytes32 s)",
            "function nonces(address) view returns (uint256)",
            "function name() view returns (string)"
        ];

        let provider;
        let coinflipContract;
        let isSpinning = false;
        let lastGameNumber = 0;

        async function updateBetStatus() {
            try {
                const isSelectingWinner = await coinflipContract.isSelectingWinner();
                const statusDisplay = document.getElementById('betStatusDisplay');

                if (isSelectingWinner) {
                    statusDisplay.innerHTML = 'Bahisler Kapalı';
                    statusDisplay.style.backgroundColor = '#FF6B6B';
                    statusDisplay.style.color = 'white';
                } else {
                    statusDisplay.innerHTML = 'Bahisler Açık';
                    statusDisplay.style.backgroundColor = '#4CAF50';
                    statusDisplay.style.color = 'white';
                }
            } catch (error) {
                console.error("Bahis durumu kontrolünde hata:", error);
            }
        }

        async function updateBetInfo() {
            try {
                let totalHeadsAmount = 0;
                let totalTailsAmount = 0;

                const headsLength = await coinflipContract.getHeadsLength();
                const tailsLength = await coinflipContract.getTailsLength();

                for (let i = 0; i < headsLength; i++) {
                    const amount = await coinflipContract.headsAmount(i);
                    totalHeadsAmount += Number(ethers.formatEther(amount));
                }

                for (let i = 0; i < tailsLength; i++) {
                    const amount = await coinflipContract.tailsAmount(i);
                    totalTailsAmount += Number(ethers.formatEther(amount));
                }

                document.getElementById('headsInfo').innerHTML = `Toplam Bahis: ${totalHeadsAmount.toFixed(2)} TOKEN`;
                document.getElementById('tailsInfo').innerHTML = `Toplam Bahis: ${totalTailsAmount.toFixed(2)} TOKEN`;
                document.getElementById('totalBetsHeader').innerHTML =
                    `TOPLAM BAHİS: ${(totalHeadsAmount + totalTailsAmount).toFixed(2)} TOKEN`;

            } catch (error) {
                console.error("Bahis bilgisi güncellenirken hata:", error);
            }
        }

        async function checkGameNumber() {
            try {
                const currentGameNumber = await coinflipContract.nthGame();
                console.log("Current game number:", currentGameNumber);
                console.log("Last game number:", lastGameNumber);

                if (currentGameNumber > lastGameNumber) {
                    // isWonTails'e göre kazananı belirle
                    const isWonTails = await coinflipContract.isWonTails();
                    console.log("Is won tails:", isWonTails);

                    // Animasyonu başlat (isWonTails false ise yazı kazanmış demektir)
                    flipCoin(!isWonTails);

                    // Kazanan tarafı vurgula
                    const headsBox = document.querySelector('.bet-box:first-child');
                    const tailsBox = document.querySelector('.bet-box:last-child');

                    if (!isWonTails) { // Yazı kazandıysa
                        headsBox.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.5)';
                        tailsBox.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                    } else { // Tura kazandıysa
                        tailsBox.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.5)';
                        headsBox.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                    }

                    setTimeout(() => {
                        headsBox.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                        tailsBox.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                    }, 5000);

                    lastGameNumber = currentGameNumber;
                }
            } catch (error) {
                console.error("Game number kontrolünde hata:", error);
            }
        }

        async function checkMyBets() {
            try {
                const signer = await provider.getSigner();
                const userAddress = await signer.getAddress();

                let myHeadsTotal = 0;
                let myTailsTotal = 0;

                // Yazı bahislerini kontrol et
                const headsLength = await coinflipContract.getHeadsLength();
                for (let i = 0; i < headsLength; i++) {
                    const bettor = await coinflipContract.heads(i);
                    if (bettor.toLowerCase() === userAddress.toLowerCase()) {
                        const amount = await coinflipContract.headsAmount(i);
                        myHeadsTotal += Number(ethers.formatEther(amount));
                    }
                }

                // Tura bahislerini kontrol et
                const tailsLength = await coinflipContract.getTailsLength();
                for (let i = 0; i < tailsLength; i++) {
                    const bettor = await coinflipContract.tails(i);
                    if (bettor.toLowerCase() === userAddress.toLowerCase()) {
                        const amount = await coinflipContract.tailsAmount(i);
                        myTailsTotal += Number(ethers.formatEther(amount));
                    }
                }

                // Sonuçları göster
                document.getElementById('myHeadsBets').textContent = `${myHeadsTotal.toFixed(2)} TOKEN`;
                document.getElementById('myTailsBets').textContent = `${myTailsTotal.toFixed(2)} TOKEN`;

            } catch (error) {
                console.error("Bahislerim kontrolünde hata:", error);
            }
        }

        async function initializeContracts() {
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                coinflipContract = new ethers.Contract(COINFLIP_ADDRESS, coinflipABI, provider);

                lastGameNumber = await coinflipContract.nthGame();

                await updateBetInfo();
                await updateBetStatus();
                await checkMyBets();

                setInterval(updateBetStatus, 2000);
                setInterval(updateBetInfo, 2000);
                setInterval(checkGameNumber, 2000);
                setInterval(checkMyBets, 2000);

            } catch (error) {
                console.error("Contract initialization error:", error);
            }
        }

        async function placeBet(isHeads, amount) {
            try {
                if (!window.ethereum) {
                    alert('MetaMask yüklü değil!');
                    return;
                }

                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const userAddress = await signer.getAddress();

                const tokenAmount = ethers.parseEther(amount);
                const deadline = Math.floor(Date.now() / 1000) + 3600;

                const tokenContract = new ethers.Contract(TOKEN_ADDRESS, tokenABI, signer);
                const coinflipContract = new ethers.Contract(COINFLIP_ADDRESS, coinflipABI, signer);

                const domain = {
                    name: await tokenContract.name(),
                    version: "1",
                    chainId: (await provider.getNetwork()).chainId,
                    verifyingContract: TOKEN_ADDRESS
                };

                const types = {
                    Permit: [
                        { name: "owner", type: "address" },
                        { name: "spender", type: "address" },
                        { name: "value", type: "uint256" },
                        { name: "nonce", type: "uint256" },
                        { name: "deadline", type: "uint256" }
                    ]
                };

                const nonce = await tokenContract.nonces(userAddress);
                const value = {
                    owner: userAddress,
                    spender: COINFLIP_ADDRESS,
                    value: tokenAmount,
                    nonce: nonce,
                    deadline: deadline
                };

                const signature = await signer.signTypedData(domain, types, value);
                const sig = ethers.Signature.from(signature);

                const tx = await (isHeads ?
                    coinflipContract.betHeads(tokenAmount, deadline, sig.v, sig.r, sig.s) :
                    coinflipContract.betTails(tokenAmount, deadline, sig.v, sig.r, sig.s));

                await tx.wait();
                alert('Bahis başarıyla yapıldı!');
                updateBetInfo();

            } catch (error) {
                console.error('Hata:', error);
                alert('Bahis yapılırken bir hata oluştu: ' + error.message);
            }
        }

        async function betHeads() {
            const amount = document.getElementById('headsAmount').value;
            if (!amount || amount <= 0) {
                alert('Lütfen geçerli bir miktar girin!');
                return;
            }
            await placeBet(true, amount);
        }

        async function betTails() {
            const amount = document.getElementById('tailsAmount').value;
            if (!amount || amount <= 0) {
                alert('Lütfen geçerli bir miktar girin!');
                return;
            }
            await placeBet(false, amount);
        }

        function flipCoin(isHeads) {
            const coin = document.getElementById('coin');
            const resultDisplay = document.getElementById('resultDisplay');

            // Önceki sonucu gizle
            resultDisplay.style.opacity = '0';

            coin.className = 'coin';
            void coin.offsetWidth;

            if (isHeads) {
                coin.classList.add('flip-heads');
            } else {
                coin.classList.add('flip-tails');
            }

            // Animasyon bitince sonucu göster
            setTimeout(() => {
                resultDisplay.innerHTML = isHeads ? 'YAZI KAZANDI! 🎉' : 'TURA KAZANDI! 🎉';
                resultDisplay.style.opacity = '1';
            }, 3000); // 3 saniye sonra (animasyon süresi kadar)
        }

        window.addEventListener('load', () => {
            initializeContracts();
        });
    </script>
</body>

</html>